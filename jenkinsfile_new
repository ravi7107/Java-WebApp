pipeline {
  agent any

  stages {
    stage ("Build the maven war package") {
      steps {
        node ("build_server") {
          
          //Checkout the SCM
          print ("Downloading the source code from GitHub")
          checkout scmGit(
            branches: [[name: '*/branch_1']], extensions: [], userRemoteConfigs: [[url: 'https://github.com/ravi7107/Java-WebApp.git']]
          )
          
          //Delete and create a new war package
          print ("Delete the old maven package")
          print ("Creating new maven package")
          sh "mvn clean install"

          //Stash the war apackage
          print ("Preparing the war package to copy to the deploy server")
          dir("/home/ubuntu/build_server/workspace/single_job_pipeline/target/") {
            //stash( includes:"/home/ubuntu/build_server/workspace/Job_3/target/WebApp.war", name: "branch_1")
            stash( includes:"WebApp.war", name: "branch_1")
          }
        }
      }
    }
    
    stage ("Deploy the maven package") {
      steps {
        node ("deployment_server") {
          //Delete the old maven package
          print ("Deleting the old maven package")
          sh "rm -rf /home/ubuntu/deployment_server/apache-tomcat-10.1.11/webapps/WebApp.war"
          
          //Unstash the maven package
          print ("Setting the directory to webapps")
          dir("/home/ubuntu/deployment_server/apache-tomcat-10.1.11/webapps") {
            print ("Getting the package from the build server")
            unstash( name: "branch_1")
          }
        }
      } 
    } 
  }
}
